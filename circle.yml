machine:
  # Environment variables for build
  environment:
    GOPATH:  "${HOME}/.go_workspace"
    WORKDIR: "${GOPATH}/src/github.com/hootsuite/atlantis"
    TERRAFORM_VERSION: 0.8.8

dependencies:
  override:
    # move repository to the canonical import path
    - mkdir -p "$(dirname ${WORKDIR})"
    - cp -R "${HOME}/atlantis" "${WORKDIR}"
    # Install dependencies
    - cd "${HOME}" && make deps

test:
  pre:
    # Test dependencies
    - cd "${HOME}" && make deps-test
  
  override:
    # Run tests
    - cd "${HOME}" && ./scripts/build.sh

  # Run e2e tests
  post:
    - cd "${HOME}" && ./scripts/e2e-deps.sh
    # Start atlantis server
    - cd "${HOME}" && ./atlantis server --gh-user="$GITHUB_USERNAME" --gh-password="$GITHUB_PASSWORD" --data-dir="/tmp" --require-approval=false --s3-bucket="$ATLANTIS_S3_BUCKET_NAME" --log-level="debug" &> /tmp/atlantis-server.log:
          background: true
    - sleep 2
    - cd "${HOME}" && ./ngrok http 4141:
          background: true
    - sleep 2
    # Set ATLANTIS_URL environment variable to be used by atlantis e2e test to create the webhook
    - echo 'export ATLANTIS_URL=$(curl -s 'http://localhost:4040/api/tunnels' | jq -r '.tunnels[1].public_url') ' >> ~/.circlerc
    - cd "${HOME}" && ./scripts/e2e.sh
